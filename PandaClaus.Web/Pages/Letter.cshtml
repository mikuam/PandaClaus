@page
@using PandaClaus.Web.Core
@model LetterModel
@{
    ViewData["Title"] = "List";
}

@section HeaderJS {
    <script>
        function confirmDelete() {
            return confirm("Czy na pewno chcesz usunąć to zdjęcie?");
        }
    </script>
}

<div class="container-xxl bg-white p-0">
    <div class="container-xxl py-5">
        <div class="container">
            @if (!string.IsNullOrEmpty(Model.ErrorMessage))
            {
                <div class="row g-5 align-items-center justify-content-center">
                    <div class="col-lg-8">
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <i class="fa fa-exclamation-triangle me-2"></i>
                            @Model.ErrorMessage
                        </div>
                        <div class="text-center mt-4">
                            <a href="/" class="btn btn-primary btn-lg">
                                <i class="fa fa-home me-2"></i>Powrót do listy listów
                            </a>
                        </div>
                    </div>
                </div>
            }
            else if (Model.Letter != null)
            {
                <!-- Letter Header -->
                <div class="letter-header wow fadeIn" data-wow-delay="0.1s">
                    <h1 class="mb-0">@Model.Letter.ChildName, @Model.Letter.ChildAge.FormatAsAge()</h1>
                    <div class="letter-number-badge">
                        <i class="fa fa-envelope me-2"></i>List numer: <strong>@Model.Letter.Number</strong>
                    </div>
                    @if (Model.Letter.IsAssigned)
                    {
                        <div class="mt-3">
                            <span class="reserved-badge">
                                <i class="fa fa-check-circle"></i>
                                List zarezerwowany
                            </span>
                        </div>
                    }
                </div>

                <!-- Image Gallery -->
                <div class="image-gallery wow fadeIn" data-wow-delay="0.2s">
                @for (int i = 0; i < Model.Letter.ImageIds.Count; i++)
                {
                    var imageId = Model.Letter.ImageIds[i];
                    var imageUrl = Model.Letter.ImageUrls[i];
                    var isDeleted = imageId.EndsWith("_delete");
                    
                    @* Skip deleted images for non-admin users *@
                    @if (isDeleted && !Model.IsAdmin)
                    {
                        continue;
                    }
                    
                    <div class="image-card">
                        <div class="image-wrapper" style="@(isDeleted ? "opacity: 0.5; position: relative;" : "")">
                            <a href="@imageUrl" target="_blank">
                                <img src="@imageUrl" alt="letter image">
                            </a>
                            @if (isDeleted)
                            {
                                <div style="position: absolute; top: 10px; left: 10px; background: rgba(220, 53, 69, 0.9); color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold;">
                                    <i class="fa fa-trash me-2"></i>USUNIĘTE
                                </div>
                            }
                        </div>
                        @if (Model.IsAdmin)
                        {
                            <div class="p-3">
                                <form method="post" class="d-inline">
                                    <input type="hidden" name="imageUrl" value="@imageUrl" />
                                    @if (isDeleted)
                                    {
                                        <button type="submit" asp-page-handler="deleteImage" asp-route-imageUrl="@imageUrl"
                                                asp-route-rowNumber="@Model.Letter.RowNumber" 
                                                class="btn btn-success btn-sm w-100">
                                            <i class="fa fa-undo me-2"></i>Przywróć zdjęcie
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="submit" asp-page-handler="deleteImage" asp-route-imageUrl="@imageUrl"
                                                asp-route-rowNumber="@Model.Letter.RowNumber" 
                                                class="btn btn-danger btn-sm w-100"
                                                onclick="return confirmDelete();">
                                            <i class="fa fa-trash me-2"></i>Usuń zdjęcie
                                        </button>
                                    }
                                </form>
                            </div>
                        }
                    </div>
                }
                </div>

                <!-- Admin Upload Section -->
                @if (Model.IsAdmin)
                {
                    <div class="admin-section wow fadeIn" data-wow-delay="0.3s">
                        <h4><i class="fa fa-user-shield me-2"></i>Panel Administratora</h4>
                        <form method="post" enctype="multipart/form-data" class="mt-3">
                            <input type="hidden" name="RowNumber" value="@Model.Letter.RowNumber">
                            <div class="row">
                                <div class="col-md-8">
                                    <label class="form-label">Dodaj zdjęcia listu</label>
                                    <input asp-for="UploadPhotos" type="file" class="form-control" 
                                           accept=".jpg, .png, .jpeg, .bmp, .tif, .tiff" required multiple>
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" asp-page-handler="uploadImage" 
                                            asp-route-rowNumber="@Model.Letter.RowNumber"
                                            class="btn btn-primary w-100">
                                        <i class="fa fa-upload me-2"></i>Dodaj zdjęcie
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                }

                <!-- Description and Presents Section -->
                <div class="row g-4 wow fadeIn" data-wow-delay="0.4s">
                    @if (Model.IsAdmin)
                    {
                        <div class="col-12">
                            <div class="admin-section">
                                <h4><i class="fa fa-edit me-2"></i>Edytuj szczegóły listu</h4>
                                <form method="post" asp-page-handler="updateDetails" asp-route-rowNumber="@Model.Letter.RowNumber" class="mt-3">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Imię dziecka</label>
                                            <input name="ChildName" type="text" class="form-control" 
                                                   value="@Model.Letter.ChildName" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Wiek dziecka</label>
                                            <input name="ChildAge" type="number" class="form-control" 
                                                   value="@Model.Letter.ChildAge" min="0" max="18" required>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Opis</label>
                                            <textarea name="Description" rows="3" class="form-control">@Model.Letter.Description</textarea>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Prezenty, o które prosi dziecko</label>
                                            <textarea name="Presents" rows="3" class="form-control">@Model.Letter.Presents</textarea>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Uwagi (widoczne tylko dla administratorów)</label>
                                            <textarea name="Uwagi" rows="3" class="form-control" placeholder="Notatki wewnętrzne, informacje dodatkowe">@Model.Letter.Uwagi</textarea>
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fa fa-save me-2"></i>Zapisz zmiany
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="admin-section">
                                <h4><i class="fa fa-trash-alt me-2"></i>Zarządzanie listem</h4>
                                <form method="post" asp-page-handler="deleteLetter" asp-route-rowNumber="@Model.Letter.RowNumber" class="mt-3">
                                    @if (Model.Letter.IsDeleted)
                                    {
                                        <div class="alert alert-warning mb-3">
                                            <i class="fa fa-exclamation-triangle me-2"></i>
                                            <strong>Ten list jest oznaczony jako usunięty.</strong> Nie będzie widoczny dla użytkowników.
                                        </div>
                                        <button type="submit" class="btn btn-success" 
                                                onclick="return confirm('Czy na pewno chcesz przywrócić ten list?');">
                                            <i class="fa fa-undo me-2"></i>Przywróć list
                                        </button>
                                    }
                                    else
                                    {
                                        <button type="submit" class="btn btn-danger" 
                                                onclick="return confirm('Czy na pewno chcesz usunąć ten list? List zostanie ukryty dla użytkowników.');">
                                            <i class="fa fa-trash me-2"></i>Usuń list
                                        </button>
                                    }
                                </form>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="col-md-6">
                            <div class="content-section">
                                <h3><i class="fa fa-info-circle me-2"></i>Opis</h3>
                                <p style="white-space: pre-wrap;">@Model.Letter.Description</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="content-section">
                                <h3><i class="fa fa-gift me-2"></i>Prezenty, o które prosi dziecko</h3>
                                <p style="white-space: pre-wrap;">@Model.Letter.Presents</p>
                            </div>
                        </div>
                    }
                </div>

                <!-- Reservation Form -->
                @if (!Model.Letter.IsAssigned)
                {
                    <div class="row mt-5 wow fadeIn" data-wow-delay="0.5s">
                        <div class="col-lg-8 offset-lg-2">
                            <div class="reservation-form">
                                <h3><i class="fa fa-heart me-2"></i>Zarezerwuj list i spełnij marzenie!</h3>
                                <form method="post">
                                    <input type="hidden" name="RowNumber" value="@Model.Letter.RowNumber">
                                    
                                    <div class="mb-4">
                                        <label class="form-label">Imię i nazwisko <span class="text-danger">*</span></label>
                                        <input asp-for="Letter.AssignedTo" type="text" class="form-control" 
                                               placeholder="Wpisz imię i nazwisko" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="form-label">Nazwa firmy</label>
                                        <input asp-for="Letter.AssignedToCompanyName" type="text" class="form-control" 
                                               placeholder="Opcjonalnie - wpisz nazwę firmy">
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="form-label">E-mail <span class="text-danger">*</span></label>
                                        <input asp-for="Letter.AssignedToEmail" type="email" class="form-control" 
                                               placeholder="Wpisz adres e-mail" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="form-label">Numer telefonu <span class="text-danger">*</span></label>
                                        <input asp-for="Letter.AssignedToPhone" type="tel" class="form-control" 
                                               placeholder="Wpisz numer telefonu" required>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="form-label">Informacje dodatkowe</label>
                                        <textarea asp-for="Letter.AssignedToInfo" rows="3" class="form-control" 
                                                  placeholder="Wpisz dodatkowe informacje (opcjonalnie)"></textarea>
                                    </div>
                                    
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-reserve">
                                            <i class="fa fa-heart me-2"></i>Zarezerwuj list
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>
